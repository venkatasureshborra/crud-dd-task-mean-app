name: CI/CD Pipeline 
on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
jobs:
  deploy-on-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Run build & deploy on VM via SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD

          script: |
            set -e

            LOG_FILE="/var/log/build_log.log"
            echo "=== Build started at $(date) ===" > $LOG_FILE

            log() {
              echo "$@" >> $LOG_FILE
            }

            safe_run() {
              "$@" >> $LOG_FILE 2>&1
            }

            REPO_URL="https://github.com/${{ github.repository }}.git"
            APP_DIR="$HOME/crud-dd-task-mean-app"

            echo "Using app directory: $APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "Cloning repository..."
              log "[Git Clone]"
              safe_run git clone "$REPO_URL" "$APP_DIR"
            else
              echo "Pulling latest changes..."
              log "[Git Pull]"
              cd "$APP_DIR"
              safe_run git pull origin main
            fi

            cd "$APP_DIR"

            echo "Logging in to Docker Hub..."
            log "[Docker Login]"
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin >> $LOG_FILE 2>&1

            echo "Building Backend image..."
            log "[Backend Build]"
            if ! safe_run docker build -t "$DOCKER_USERNAME/crud-backend:latest" ./backend; then
              echo "❗Backend build failed — check logs in /var/log/build_log.log"
              exit 1
            fi
            echo "Finished."

            echo "Building Frontend image..."
            log "[Frontend Build]"
            if ! safe_run docker build -t "$DOCKER_USERNAME/crud-frontend:latest" ./frontend; then
              echo "❗Frontend build failed — check logs in /var/log/build_log.log"
              exit 1
            fi
            echo "Finished."

            echo "Pushing images to DockerHub..."
            log "[Docker Push]"
            safe_run docker push "$DOCKER_USERNAME/crud-backend:latest"
            safe_run docker push "$DOCKER_USERNAME/crud-frontend:latest"
            echo "Finished."

            echo "Deploying with docker-compose..."
            log "[Container Deploy]"

            if [ -f docker-compose.yml ]; then
              echo "Stopping existing containers..."
              safe_run docker-compose down || true
            fi

            echo "Pulling latest images..."
            safe_run docker compose pull || safe_run docker-compose pull

            echo "Starting services..."
            if ! safe_run docker-compose up -d; then
              echo "❗Deployment failed — check logs in /var/log/build_log.log"
              exit 1
            fi
            echo "Finished."

            echo "Cleaning old unused images..."
            log "[Cleanup Images]"
            safe_run docker image prune -f
            echo "Finished."

            echo "Removing untagged <none> images..."
            if docker images | grep -q "<none>"; then
              safe_run docker rmi $(docker images -f "dangling=true" -q) -f || true
            else
              echo "No dangling images found."
            fi
            echo "Finished."

            echo "Cleaning unused containers & volumes..."
            log "[Cleanup Containers]"
            safe_run docker container prune -f
            safe_run docker volume prune -f
            echo "Finished."

            echo "All tasks completed."
            log "=== Build Finished Successfully at $(date) ==="
            
            # SUCCESS → CLEAR LOG
            echo "" > $LOG_FILE

        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
